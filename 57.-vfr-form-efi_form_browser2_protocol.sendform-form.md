# 57. VFR을 사용해 간단한 form 생성 및 EFI\_FORM\_BROWSER2\_PROTOCOL.SendForm()를 통해 화면에 form 표시하기

HII의 주요 목적은 UEFI 설정을 제어하기 위해 사용자 구성 메뉴에 표시하는 것이다.

지금까지 HII Strings와 HII Fonts에 대해서 알아보았다. 이제 모든 것을 하나로 묶는 HII forms에 대해 알아본다.

HII forms 패키지의 데이터는 IFR이 내부 form 표현을 나타내는 특수 IFR 형식으로 인코딩된다. IFR은 사람이 읽을 수 있는 것이 아니기 때문에 직접 form 패키지를 구성하는 것은 쉽지 않다. 일련의 작동 코드(opcode)로 파싱 프로세스가 매우 지루할 수 있다.

EDK2는 VFR이라는 특별한 사람이 사람 친화적인 언어로 HII form을 작성하는 방법을 제공한다. 여기서 VFR은 시각적 form 표현 (내부  form 표현의 반대)을 나타낸다. \
[https://edk2-docs.gitbook.io/edk-ii-vfr-specification/](https://edk2-docs.gitbook.io/edk-ii-vfr-specification/)\
EDK2에는 IFR opcode로 VFR 코드를 C 배열로 변환하는 `VfrCompile`이라는 특수 유틸리티가 있다.\
[https://github.com/tianocore/edk2/tree/master/BaseTools/Source/C/VfrCompile](https://github.com/tianocore/edk2/tree/master/BaseTools/Source/C/VfrCompile)

HiiLib을 사용해 form을 볼 수 있는 간단한HIISimpleForm 애플리케이션을 생성한다.

```
[Defines]
  INF_VERSION                    = 1.25
  BASE_NAME                      = HIISimpleForm
  FILE_GUID                      = df2f1465-2bf1-492c-af6c-232ac40bdf82
  MODULE_TYPE                    = UEFI_APPLICATION
  VERSION_STRING                 = 1.0
  ENTRY_POINT                    = UefiMain

[Sources]
  HIISimpleForm.c

[Packages]
  MdePkg/MdePkg.dec
  MdeModulePkg/MdeModulePkg.dec

[LibraryClasses]
  UefiApplicationEntryPoint
  UefiLib
  HiiLib
```

```
#include <Library/UefiBootServicesTableLib.h>
#include <Library/UefiLib.h>

#include <Library/HiiLib.h>

EFI_STATUS
EFIAPI
UefiMain (
  IN EFI_HANDLE        ImageHandle,
  IN EFI_SYSTEM_TABLE  *SystemTable
  )
{
  return EFI_SUCCESS;
}
```

`UefiLessonsPkg/UefiLessonsPkg.dsc`에 inf 파일을 추가한다.

```
[Components]
  ...
  UefiLessonsPkg/HIISimpleForm/HIISimpleForm.inf
```

이제 vfr 파일을 생성한다.

```
#define HIISIMPLEFORM_FORMSET_GUID  {0xef2acc91, 0x7b50, 0x4ab9, {0xab, 0x67, 0x2b, 0x4, 0xf8, 0xbc, 0x13, 0x5e}}

formset
  guid     = HIISIMPLEFORM_FORMSET_GUID,
  title    = STRING_TOKEN(HIISIMPLEFORM_FORMSET_TITLE),
  help     = STRING_TOKEN(HIISIMPLEFORM_FORMSET_HELP),
endformset;
```

VFR의 모든 항목은 `formset` 내에서 인코딩되어야 한다. 이 요소는 `formset` 키워드로 시작해서 `endformset`으로 끝나야 한다. formset을 구성할 때는 필수로 `guid`, `title`, `help` 총 3개의 필드가 있어야 한다.

이제 `guid`를 인코딩 할 수 있다.

```
guid     = {0xef2acc91, 0x7b50, 0x4ab9, {0xab, 0x67, 0x2b, 0x4, 0xf8, 0xbc, 0x13, 0x5e}}
```

또는 이전에 했던 것처럼 C 구문과 유사한 정의문으로 작성할 수 있다.

`title`과 `help` 필드에는 문자열의 문자열 ID가 포함되어야 한다. 따라서 필요한 ID를 얻기 위해 `STRING_TOKEN(...)`를 사용하고 문자열 자체는 UNI 파일(`UefiLessonsPkg/HIISimpleForm/Strings.uni`)로 인코딩되어야 한다.

```
#langdef en-US "English"

#string HIISIMPLEFORM_FORMSET_TITLE          #language en-US  "Simple Formset"
#string HIISIMPLEFORM_FORMSET_HELP           #language en-US  "This is a very simple formset"
```

